#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json

ESCAPE = {ord('\\'): r'\\', ord('_'): r'\_', ord('['): r'\[', ord(']'): r'\]'}


def _escape(s: str) -> str:
    return ''.join(
        # leave text alone inside `backticks`
        part.translate(ESCAPE) if i % 2 == 0 else f'`{part}`'
        for i, part in enumerate(s.strip().split('`'))
    )


def _video_link(video: dict[str, str]) -> str:
    return f'[{_escape(video["title"])}]({video["url"]})'


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument('input_json')
    parser.add_argument('output')
    args = parser.parse_args()

    with open(args.input_json) as f:
        contents = json.load(f)

    playlist, = [
        playlist
        for playlist in contents['playlists']
        if playlist['playlist_name'] == 'explains'
    ]
    playlist_id = playlist['playlist_id']

    with open(args.output, 'w') as f:
        f.write('explains\n')
        f.write('========\n')
        f.write('\n')
        f.write('[update playlist]\n')
        f.write('\n')
        f.write('the full [playlist] is on youtube\n')
        f.write('\n')
        f.write('[update playlist]: https://github.com/anthonywritescode/explains/actions?query=workflow%3Aupdate\n')  # noqa: E501
        playlist_link = f'https://www.youtube.com/playlist?list={playlist_id}'
        f.write(f'[playlist]: {playlist_link}\n')
        f.write('\n')

        for video in playlist['videos']:
            f.write(f'- {_video_link(video)}\n')

    return 0


if __name__ == '__main__':
    raise SystemExit(main())
